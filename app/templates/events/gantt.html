{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Application Deadlines - Gantt Chart View</h2>
    <div class="gantt-container">
        <svg id="gantt"></svg>
    </div>

    <div id="gantt-custom-popup"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Get the custom popup element
        const popup = document.getElementById('gantt-custom-popup');
        
        // --- NEW ---
        // This variable will temporarily hold the task data when a bar is clicked
        let activeTask = null; 

        // This event listener handles closing the popup via the 'x'
        popup.addEventListener('click', function(event) {
            if (event.target.id === 'gantt-popup-close') {
                popup.style.display = 'none';
                activeTask = null; // Clear the active task
            }
        });

        // 2. Fetch the data from your new API endpoint
        fetch("{{ url_for('events.list_events_gantt_json') }}")
            .then(response => response.json())
            .then(tasks => {
                if (tasks.length > 0) {
                    // 3. Initialize Frappe Gantt
                    var gantt = new Gantt("#gantt", tasks, {
                        header_height: 50,
                        bar_height: 25,
                        view_mode: 'Month',
                        date_format: 'YYYY-MM-DD',
                        
                        // 4. --- MODIFIED ---
                        // on_click now *only* saves the task data.
                        // It doesn't try to show the popup.
                        on_click: function (task) {
                            activeTask = task; // Store the clicked task's data
                        }
                    });

                    // 5. --- MODIFIED ---
                    // This global click listener handles *all* popup logic
                    document.addEventListener('click', function(event) {
                        
                        // Check if the click was ON a gantt bar AND we have task data
                        if (event.target.closest('.bar-wrapper') && activeTask) {
                            // A bar was clicked! Now we build and show the popup.
                            const startDate = new Date(activeTask.start).toLocaleDateString();
                            const endDate = new Date(activeTask.end).toLocaleDateString();
                            const link = activeTask.source_url 
                                ? `<a href="${activeTask.source_url}" target="_blank">View Source</a>` 
                                : '<span>No link available</span>';

                            // Build the HTML with the 'X' button
                            popup.innerHTML = `
                                <span id="gantt-popup-close">&times;</span>
                                <h5>${activeTask.name}</h5>
                                <p><strong>Dates:</strong> ${startDate} - ${endDate}</p>
                                <p>${link}</p>
                            `;
                            
                            // Position and show the popup using the 'event'
                            // variable, which is correctly defined here.
                            popup.style.left = (event.clientX + 5) + 'px';
                            popup.style.top = (event.clientY + 5) + 'px';
                            popup.style.display = 'block';

                            // Clear the task so it doesn't re-trigger
                            activeTask = null; 
                        
                        } else if (!popup.contains(event.target)) {
                            // If the click was *outside* the popup, hide it
                            popup.style.display = 'none';
                        }
                        
                    }, true); // Use 'true' for capture phase

                } else {
                    document.querySelector(".gantt-container").innerHTML = "<p>No events to display.</p>";
                }
            })
            .catch(error => console.error('Error fetching Gantt data:', error));
    });
</script>
{% endblock %}
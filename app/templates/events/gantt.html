{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Application Deadlines - Gantt Chart View</h2>
    <div class="gantt-container">
        <svg id="gantt"></svg>
    </div>

    <div id="gantt-custom-popup"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Get the custom popup element
        const popup = document.getElementById('gantt-custom-popup');

        // --- IMPROVEMENT ---
        // Add ONE event listener to the popup.
        // This will catch clicks on the 'x' button when it's created.
        popup.addEventListener('click', function(event) {
            if (event.target.id === 'gantt-popup-close') {
                popup.style.display = 'none';
            }
        });

        // 2. Fetch the data from your new API endpoint
        fetch("{{ url_for('events.list_events_gantt_json') }}")
            .then(response => response.json())
            .then(tasks => {
                if (tasks.length > 0) {
                    // 3. Initialize Frappe Gantt
                    var gantt = new Gantt("#gantt", tasks, {
                        header_height: 50,
                        bar_height: 25,
                        view_mode: 'Month',
                        date_format: 'YYYY-MM-DD',
                        
                        // 4. Use 'on_click' to populate and show the popup
                        on_click: function (task) {
                            // Format dates
                            const startDate = new Date(task.start).toLocaleDateString();
                            const endDate = new Date(task.end).toLocaleDateString();

                            // Create link HTML
                            const link = task.source_url 
                                ? `<a href="${task.source_url}" target="_blank">View Source</a>` 
                                : '<span>No link available</span>';

                            // Build the custom HTML with the 'X' button
                            popup.innerHTML = `
                                <span id="gantt-popup-close">&times;</span>
                                <h5>${task.name}</h5>
                                <p><strong>Dates:</strong> ${startDate} - ${endDate}</p>
                                <p>${link}</p>
                            `;
                            
                            // Position and show the popup near the mouse
                            popup.style.left = (event.clientX + 5) + 'px';
                            popup.style.top = (event.clientY + 5) + 'px';
                            popup.style.display = 'block';
                        }
                    });

                    // 5. Add a global click listener to close the popup
                    //    if the user clicks anywhere else on the page.
                    document.addEventListener('click', function(event) {
                        // Check if the click is outside the popup AND
                        // not on a gantt bar (which would re-open it)
                        if (!popup.contains(event.target) && !event.target.closest('.bar-wrapper')) {
                            popup.style.display = 'none';
                        }
                    }, true); // Use 'true' for capture phase

                } else {
                    document.querySelector(".gantt-container").innerHTML = "<p>No events to display.</p>";
                }
            })
            .catch(error => console.error('Error fetching Gantt data:', error));
    });
</script>
{% endblock %}